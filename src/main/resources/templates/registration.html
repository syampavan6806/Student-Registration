<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rushi Tech - Course Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="css/rushi-style.css" rel="stylesheet" type="text/css"/>
</head>

<body>
  <header class="header">
    <span>Rushi Technologies — Balaji Reddy Lachhannagari</span>
  </header>

  <main class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h2 style="margin:0;">Registrations</h2>
      <button type="button" id="addBtn" onclick="openModal()">+ Add Registration</button>
    </div>

    <!-- Success + Error Notifications -->
    <div id="successMsg" class="success-message" role="status" aria-live="polite"></div>
    <div id="errorMsg" class="error-message" role="alert" aria-live="assertive"></div>

    <!-- Table -->
    <div class="table-wrap">
      <table id="regTable">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Phone</th>
            <th scope="col">Course</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal for Add/Edit Registration -->
    <div id="regModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle" class="modal-title">Add Registration</h3>
          <button type="button" class="close" aria-label="Close modal" onclick="closeModal()">&times;</button>
        </div>

        <form id="regForm">
          <input type="hidden" id="regId" />

          <label for="name">Name</label>
          <input type="text" id="name" required autocomplete="name" />

          <label for="email">Email</label>
          <input type="email" id="email" required autocomplete="email" />

          <label for="phone">Phone</label>
          <input type="text" id="phone" required pattern="^[0-9]{10}$" inputmode="numeric" placeholder="10-digit number" />

          <label for="course">Course</label>
          <select id="course" required>
            <option value="" disabled selected>Select Course</option>
            <option>DevOps</option>
            <option>AWS</option>
            <option>Azure</option>
            <option>Terraform</option>
            <option>Kubernetes</option>
            <option>Python</option>
	        <option>DotNet</option>
	        <option>DevSecOps</option>


          </select>

          <div style="display:flex; gap:10px; margin-top:16px;">
            <button type="submit" id="saveBtn">Save</button>
            <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Trainer / Branding (3-column layout) -->
    <div class="trainer-section">
      <div class="trainer-left">
        <img th:src="@{/images/trainer.jpg}" alt="Trainer Photo" class="trainer-img" />
      </div>

      <div class="trainer-info">
        <p class="trainer-lines">
          <span class="label">Trainer:</span> <b>Mr. Balaji Reddy L</b><br />
          <span class="label">Contact:</span> <b>+91-9900012028</b><br />
          <span class="label">Server IP:</span> <span th:text="${serverIp}">—</span><br />
          <span class="label">Client IP:</span> <span th:text="${clientIp}">—</span>
        </p>
      </div>

      <div class="trainer-right">
        <img th:src="@{/images/logo.png}" alt="Rushi Technologies logo" class="logo-img" />
      </div>
    </div>
  </main>

  <script>
    // Context path detection
    const pathParts = window.location.pathname.split('/');
    let contextPath = '';
    if (pathParts.length > 1 && pathParts[1] && pathParts[1] !== 'api') {
      contextPath = '/' + pathParts[1];
    }

    // Modal helpers
    function openModal(edit=false, reg={}) {
      const modal = document.getElementById('regModal');
      modal.classList.add('open');
      document.getElementById('modalTitle').innerText = edit ? 'Edit Registration' : 'Add Registration';
      document.getElementById('regId').value = reg.id || '';
      document.getElementById('name').value = reg.name || '';
      document.getElementById('email').value = reg.email || '';
      document.getElementById('phone').value = reg.phone || '';
      document.getElementById('course').value = reg.course || '';
      setTimeout(()=>document.getElementById('name').focus(), 10);
    }
    function closeModal() {
      const modal = document.getElementById('regModal');
      modal.classList.remove('open');
      document.getElementById('regForm').reset();
      document.getElementById('regId').value = '';
    }

    // Close modal with ESC / backdrop click
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        const modalOpen = document.querySelector('.modal.open');
        if(modalOpen) closeModal();
      }
    });
    document.getElementById('regModal').addEventListener('click', (e)=>{
      if(e.target.id === 'regModal') closeModal();
    });

    // Toast helpers
    function showSuccess(msg) {
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }
    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    // Fetch and render registrations
    function fetchRegistrations() {
      fetch(`${contextPath}/api/registrations`)
        .then(res => {
          if (!res.ok) throw new Error(`Server error: ${res.status}`);
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector('#regTable tbody');
          tbody.innerHTML = '';
          data.forEach(reg => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${reg.name}</td>
              <td>${reg.email}</td>
              <td>${reg.phone}</td>
              <td>${reg.course}</td>
              <td>
                <div class="action-btns">
                  <button type="button" onclick='editReg(${JSON.stringify(reg)})'>Edit</button>
                  <button type="button" class="secondary" onclick='deleteReg(${reg.id})'>Delete</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          showError("Failed to load registrations. Please try again later.");
          console.error("Fetch error:", err);
        });
    }
    fetchRegistrations();

    // Add/Edit submit
    document.getElementById('regForm').onsubmit = function(e) {
      e.preventDefault();
      const id = document.getElementById('regId').value;
      const reg = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        course: document.getElementById('course').value
      };
      const method = id ? 'PUT' : 'POST';
      const url = id ? `${contextPath}/api/registrations/${id}` : `${contextPath}/api/registrations`;

      fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(reg)
      })
      .then(res => {
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        return res.json().catch(() => ({}));
      })
      .then(() => {
        closeModal();
        fetchRegistrations();
        showSuccess(id ? 'Registration updated successfully!' : 'Registration added successfully!');
      })
      .catch(err => {
        showError("Could not save registration. Please check DB/API connection.");
        console.error("Save error:", err);
      });
    };

    // Edit/Delete
    window.editReg = function(reg) { openModal(true, reg); };
    window.deleteReg = function(id) {
      if(confirm('Are you sure you want to delete this registration?')) {
        fetch(`${contextPath}/api/registrations/${id}`, { method: 'DELETE' })
          .then(res => {
            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            fetchRegistrations();
            showSuccess('Registration deleted successfully!');
          })
          .catch(err => {
            showError("Could not delete registration. Please try again later.");
            console.error("Delete error:", err);
          });
      }
    };
  </script>
</body>
</html>
